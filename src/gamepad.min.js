Blockly.Gamepad=class{constructor(e){e=e||{},this.worker=new Blockly.Gamepad.Worker,this.blocklyManager=new Blockly.Gamepad.BlocklyManager(e),this.jsonManager=new Blockly.Gamepad.JsonManager,this.magicJson=!0===e.magicJson,this.highlight=void 0!==e.customHighlight,this.reset(),this.worker.onRequest(this,this.onRequest)}get level(){return this.jsonManager.observer}set level(e){this.jsonManager.init([e])}get levels(){return this.jsonManager.observers}set levels(e){if(!Array.isArray(e))throw new Error("levels argument must be an array");this.jsonManager.init(e)}onRequest(e,t,r){!this.blocklyManager.isCoding&&this.highlight&&this.blocklyManager.setHighlight(e.id),e.method!=Blockly.Gamepad.STATES.STARTED||this.state!=Blockly.Gamepad.STATES.FINISHED&&this.state!=Blockly.Gamepad.STATES.COMPLETED||t||this.jsonManager.loadNext(),e.method!=Blockly.Gamepad.STATES.FINISHED&&e.method!=Blockly.Gamepad.STATES.COMPLETED||this.state!=Blockly.Gamepad.STATES.STARTED||!t||this.jsonManager.loadPrior(),this.magicJson&&r&&(t?this.jsonManager.unloadChanges():this.jsonManager.loadChanges());let o=this.game(e,t,r);return e.method!=Blockly.Gamepad.STATES.STARTED&&e.method!=Blockly.Gamepad.STATES.FINISHED&&e.method!=Blockly.Gamepad.STATES.COMPLETED||(this.state=e.method),this.magicJson&&!r&&this.jsonManager.commit(),o}setGame(e,t){if("function"!=typeof t)throw new Error("method is not a function");this.game=function(){return t.apply(e,[...arguments])}}load(e){if(this.state=Blockly.Gamepad.STATES.STARTED,void 0!==e&&(isNaN(e)||e<1))throw new Error("times must be a number greater than 0.");e=e||1,this.worker.reset();let t=this.blocklyManager.code(e);return this.jsonManager.reset(),Blockly.Gamepad.evalContext(t,this.worker.getInstance()),this.blocklyManager.getBlocksNumber()}reset(){this.state=Blockly.Gamepad.STATES.STARTED,this.jsonManager.reset(),this.worker.reset(),this.blocklyManager.reset()}setToolbox(e){this.blocklyManager.setToolbox(e)}forward(){return this.worker.stop(),this.worker.go(!1)}backward(){return this.worker.stop(),this.worker.go(!0)}play(e){this.worker.removeBreakpoint(),this.worker.freeQueue(),this.worker.start(e)}pause(){this.worker.stop(),this.worker.freeQueue()}togglePlay(){this.worker.isRunning?this.pause():this.play(this.worker.back)}debug(e,t){let r=this.worker.setBreakpoint(e);return this.worker.start(t),r}save(e){this.blocklyManager.save(e)}restore(e){this.blocklyManager.restore(e)}static version(){return"1.0.0"}},Blockly.Gamepad.SYMBOL=Symbol("gamepad.js"),Blockly.Gamepad.TOOLBOX={},Blockly.Gamepad.CONTEXT={},Blockly.Gamepad.INPUTS={},Blockly.Gamepad.ERRORS={CLOSED:"CLOSED",FINISHED:"FINISHED",COMPLETED:"COMPLETED"},Blockly.Gamepad.STATES={STARTED:"STARTED",FINISHED:"FINISHED",COMPLETED:"COMPLETED"},Blockly.Gamepad.BLOCKS={START:"start"},Blockly.Gamepad.TEMPLATES={WHILE:"while",DO_WHILE:"do_while",IF:"if",IF_ELSE:"if_else"},Blockly.Gamepad.utils={xml2json:function(e,t){var r={toObj:function(e){var t={};if(1==e.nodeType){if(e.attributes.length)for(var o=0;o<e.attributes.length;o++)t["@"+e.attributes[o].nodeName]=(e.attributes[o].nodeValue||"").toString();if(e.firstChild){for(var s=0,a=0,l=!1,i=e.firstChild;i;i=i.nextSibling)1==i.nodeType?l=!0:3==i.nodeType&&i.nodeValue.match(/[^ \f\n\r\t\v]/)?s++:4==i.nodeType&&a++;if(l)if(s<2&&a<2){r.removeWhite(e);for(i=e.firstChild;i;i=i.nextSibling)3==i.nodeType?t["#text"]=r.escape(i.nodeValue):4==i.nodeType?t["#cdata"]=r.escape(i.nodeValue):t[i.nodeName]?t[i.nodeName]instanceof Array?t[i.nodeName][t[i.nodeName].length]=r.toObj(i):t[i.nodeName]=[t[i.nodeName],r.toObj(i)]:t[i.nodeName]=r.toObj(i)}else e.attributes.length?t["#text"]=r.escape(r.innerXml(e)):t=r.escape(r.innerXml(e));else if(s)e.attributes.length?t["#text"]=r.escape(r.innerXml(e)):t=r.escape(r.innerXml(e));else if(a)if(a>1)t=r.escape(r.innerXml(e));else for(i=e.firstChild;i;i=i.nextSibling)t["#cdata"]=r.escape(i.nodeValue)}e.attributes.length||e.firstChild||(t=null)}else 9==e.nodeType&&(t=r.toObj(e.documentElement));return t},toJson:function(e,t,o){var s=t?'"'+t+'"':"";if(e instanceof Array){for(var a=0,l=e.length;a<l;a++)e[a]=r.toJson(e[a],"",o+"\t");s+=(t?":[":"[")+(e.length>1?"\n"+o+"\t"+e.join(",\n"+o+"\t")+"\n"+o:e.join(""))+"]"}else if(null==e)s+=(t&&":")+"null";else if("object"==typeof e){var i=[];for(var n in e)i[i.length]=r.toJson(e[n],n,o+"\t");s+=(t?":{":"{")+(i.length>1?"\n"+o+"\t"+i.join(",\n"+o+"\t")+"\n"+o:i.join(""))+"}"}else s+="string"==typeof e?(t&&":")+'"'+e.toString()+'"':(t&&":")+e.toString();return s},innerXml:function(e){var t="";if("innerHTML"in e)t=e.innerHTML;else for(var r=function(e){var t="";if(1==e.nodeType){t+="<"+e.nodeName;for(var o=0;o<e.attributes.length;o++)t+=" "+e.attributes[o].nodeName+'="'+(e.attributes[o].nodeValue||"").toString()+'"';if(e.firstChild){t+=">";for(var s=e.firstChild;s;s=s.nextSibling)t+=r(s);t+="</"+e.nodeName+">"}else t+="/>"}else 3==e.nodeType?t+=e.nodeValue:4==e.nodeType&&(t+="<![CDATA["+e.nodeValue+"]]>");return t},o=e.firstChild;o;o=o.nextSibling)t+=r(o);return t},escape:function(e){return e.replace(/[\\]/g,"\\\\").replace(/[\"]/g,'\\"').replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r")},removeWhite:function(e){e.normalize();for(var t=e.firstChild;t;)if(3==t.nodeType)if(t.nodeValue.match(/[^ \f\n\r\t\v]/))t=t.nextSibling;else{var o=t.nextSibling;e.removeChild(t),t=o}else 1==t.nodeType?(r.removeWhite(t),t=t.nextSibling):t=t.nextSibling;return e}};9==e.nodeType&&(e=e.documentElement);var o=r.toJson(r.toObj(r.removeWhite(e)),e.nodeName,"\t");return"{\n"+t+(t?o.replace(/\t/g,t):o.replace(/\t|\n/g,""))+"\n}"},json2xml:function(e,t){var r=function(e,t,o){var s="";if(e instanceof Array)for(var a=0,l=e.length;a<l;a++)s+=o+r(e[a],t,o+"\t")+"\n";else if("object"==typeof e){var i=!1;for(var n in s+=o+"<"+t.toLowerCase(),e)"@"==n.charAt(0)?s+=" "+n.substr(1)+'="'+e[n].toString()+'"':i=!0;if(s+=i?">":"/>",i){for(var n in e)"#text"==n?s+=e[n]:"#cdata"==n?s+="<![CDATA["+e[n]+"]]>":"@"!=n.charAt(0)&&(s+=r(e[n],n,o+"\t"));s+=("\n"==s.charAt(s.length-1)?o:"")+"</"+t.toLowerCase()+">"}}else s+=o+"<"+t+">"+e.toString()+"</"+t+">";return s},o="";for(var s in e)o+=r(e[s],s.toString().toLowerCase(),"");return t?o.replace(/\t/g,t):o.replace(/\t|\n/g,"")},filter:function(e,t){let r=!1,o=!1;if("PROCEDURE"==e["@custom"])return!1!==t.procedure;if("VARIABLE"==e["@custom"])return!1!==t.variable;if(e.CATEGORY){let o;for(o=0;o<e.CATEGORY.length;o++)Blockly.Gamepad.utils.filter(e.CATEGORY[o],t)||(e.CATEGORY.splice(o,1),o--);o>0&&(r=!0)}if(e.BLOCK){let r;for(r=0;r<e.BLOCK.length;r++)t.blocks.includes(e.BLOCK[r]["@type"])||(e.BLOCK.splice(r,1),r--);r>0&&(o=!0)}return r||o},blocks:function(e){let t=[];for(let r in e){let o=e[r],s=!1,a=!1;if("statements"in o){if(!Array.isArray(o.statements)||0==o.statements.length)throw new Error("statements must be an array of string");s=!0}if("template"in o){if(!Object.values(Blockly.Gamepad.TEMPLATES).includes(o.template))throw new Error("template must be one of Blockly.Gamepad['TEMPLATES']");a=!0}if(a&&!s)throw new Error("a template block require at least a statement");if(!a&&s)throw new Error("statements setted without the template");Blockly.JavaScript[""+r]=Blockly.Gamepad.utils.js(o.method,o.args,o.order,o.template,o.statements),"json"in o?(o.json.type=r,t.push(o.json)):"javascript"in o&&(Blockly.Blocks[r]=o.javascript)}Blockly.defineBlocksWithJsonArray(t)},wrap:function(e){if(!Array.isArray(e))throw new Error("blocks must be an array of block types");for(let t of e){if(!(t in Blockly.JavaScript))throw new Error("The following type does not exist: "+t);let e=Blockly.JavaScript[t];switch(t){case"procedures_defnoreturn":case"procedures_defreturn":Blockly.JavaScript[t]=function(e){var r=Blockly.JavaScript.variableDB_.getName(e.getFieldValue("NAME"),Blockly.Procedures.NAME_TYPE),o=Blockly.JavaScript.statementToCode(e,"STACK");if(Blockly.JavaScript.STATEMENT_PREFIX){var s=e.id.replace(/\$/g,"$$$$");o=Blockly.JavaScript.prefixLines(Blockly.JavaScript.STATEMENT_PREFIX.replace(/%1/g,"'"+s+"'"),Blockly.JavaScript.INDENT)+o}Blockly.JavaScript.INFINITE_LOOP_TRAP&&(o=Blockly.JavaScript.INFINITE_LOOP_TRAP.replace(/%1/g,"'"+e.id+"'")+o),(s=Blockly.JavaScript.valueToCode(e,"RETURN",Blockly.JavaScript.ORDER_NONE)||"")&&(s=Blockly.JavaScript.INDENT+"return "+s+";\n");for(var a=[],l=0;l<e.arguments_.length;l++)a[l]=Blockly.JavaScript.variableDB_.getName(e.arguments_[l],Blockly.Variables.NAME_TYPE);return o="async function "+r+"("+a.join(", ")+") {\n"+Blockly.Gamepad.utils.request(t,[r],e.id)+o+s+"\n}",o=Blockly.JavaScript.scrub_(e,o),Blockly.JavaScript.definitions_["%"+r]=o,null};break;default:Blockly.JavaScript[t]=function(r){let o=e.apply(this,[...arguments]),s=Blockly.Gamepad.utils.request(t,[],r.id);return Array.isArray(o)?o[0]=s.slice(0,-1)+".then(async () => "+o[0]+" )\n":o=s+o,o}}}},build:function(e,t,r,o){return"string"!=typeof e&&(e=""),Array.isArray(t)||(t=[]),"string"!=typeof e&&(r=""),o?{method:e,args:t,id:r,data:o}:{method:e,args:t,id:r}},request:function(e,t,r,o){let s=Blockly.Gamepad.utils.build(e,t,r),a=`await worker.setRequest({ ${e=`method: '${s.method}'`}, ${t=`args: ${JSON.stringify(s.args)}`}, ${r=`id: '${s.id}'`} })\n`;return null!=o?[a,o]:a},js:function(e,t,r,o,s){return t=Array.isArray(t)?t:[],s=Array.isArray(s)?s:[],function(a){let l=[],i=[];for(let e of t){let t="function"==typeof e.get?e.get:e=>e;null!=e.field?l.push(t(a.getFieldValue(e.field))):null!=e.input?l.push(t(Blockly.Gamepad.INPUTS[e.input])):null!=e.value&&l.push(t(e.value))}for(let e of s)i.push(Blockly.JavaScript.statementToCode(a,e));switch(o){case Blockly.Gamepad.TEMPLATES.WHILE:return"while("+Blockly.Gamepad.utils.request(e,l,a.id)+"){\n"+i[0]+"}";case Blockly.Gamepad.TEMPLATES.DO_WHILE:return"do{"+i[0]+"}while{\n"+Blockly.Gamepad.utils.request(e,l,a.id)+"}";case Blockly.Gamepad.TEMPLATES.IF:return"if("+Blockly.Gamepad.utils.request(e,l,a.id)+"){\n"+i[0]+"}";case Blockly.Gamepad.TEMPLATES.IF_ELSE:return"if("+Blockly.Gamepad.utils.request(e,l,a.id)+"){\n"+i[0]+"}else{"+i[1]+"}";default:return Blockly.Gamepad.utils.request(e,l,a.id,r)}}},code:function(e,t){return"async function f() {\n   try{\n"+(e=("try {\n"+Blockly.Gamepad.utils.request(Blockly.Gamepad.STATES.STARTED,[],Blockly.Gamepad.STATES.STARTED)+e+Blockly.Gamepad.utils.request(Blockly.Gamepad.STATES.FINISHED,[],Blockly.Gamepad.STATES.FINISHED)+'} catch(error) { if(error != Blockly.Gamepad["ERRORS"]["FINISHED"]) throw error; }\n').repeat(t))+(t>1?Blockly.Gamepad.utils.request(Blockly.Gamepad.STATES.COMPLETED,[],Blockly.Gamepad.STATES.COMPLETED):"")+'       worker.close();\n   }catch(error){ if(error != Blockly.Gamepad["ERRORS"]["COMPLETED"]) { throw error; } }\n   }\nf();'},promiseWrapper:function(){let e,t=new Promise(t=>{e=t});var r=!0,o=!1;return t.isFulfilled=function(){return o},t.isPending=function(){return r},t.resolve=function(t){r=!1,o=!0,e(t)},t},errorHandler:function(e){if(e!==Blockly.Gamepad.ERRORS.CLOSED)throw e}},Blockly.Gamepad.setting=function(){Blockly.Trashcan.prototype.clear=function(){this.contents_=new Array},Blockly.Scrollbar.scrollbarThickness=12,Blockly.JavaScript.procedures_defreturn=function(e){var t=Blockly.JavaScript.variableDB_.getName(e.getFieldValue("NAME"),Blockly.Procedures.NAME_TYPE),r=Blockly.JavaScript.statementToCode(e,"STACK");if(Blockly.JavaScript.STATEMENT_PREFIX){var o=e.id.replace(/\$/g,"$$$$");r=Blockly.JavaScript.prefixLines(Blockly.JavaScript.STATEMENT_PREFIX.replace(/%1/g,"'"+o+"'"),Blockly.JavaScript.INDENT)+r}Blockly.JavaScript.INFINITE_LOOP_TRAP&&(r=Blockly.JavaScript.INFINITE_LOOP_TRAP.replace(/%1/g,"'"+e.id+"'")+r),(o=Blockly.JavaScript.valueToCode(e,"RETURN",Blockly.JavaScript.ORDER_NONE)||"")&&(o=Blockly.JavaScript.INDENT+"return "+o+";\n");for(var s=[],a=0;a<e.arguments_.length;a++)s[a]=Blockly.JavaScript.variableDB_.getName(e.arguments_[a],Blockly.Variables.NAME_TYPE);return r="async function "+t+"("+s.join(", ")+") {\n"+r+o+"\n}",r=Blockly.JavaScript.scrub_(e,r),Blockly.JavaScript.definitions_["%"+t]=r,null},Blockly.JavaScript.procedures_defnoreturn=Blockly.JavaScript.procedures_defreturn,Blockly.JavaScript.procedures_callreturn=function(e){for(var t=Blockly.JavaScript.variableDB_.getName(e.getFieldValue("NAME"),Blockly.Procedures.NAME_TYPE),r=[],o=0;o<e.arguments_.length;o++)r[o]=Blockly.JavaScript.valueToCode(e,"ARG"+o,Blockly.JavaScript.ORDER_COMMA)||"null";return["await "+t+"("+r.join(", ")+")",Blockly.JavaScript.ORDER_FUNCTION_CALL]},Blockly.JavaScript.procedures_callnoreturn=function(e){for(var t=Blockly.JavaScript.variableDB_.getName(e.getFieldValue("NAME"),Blockly.Procedures.NAME_TYPE),r=[],o=0;o<e.arguments_.length;o++)r[o]=Blockly.JavaScript.valueToCode(e,"ARG"+o,Blockly.JavaScript.ORDER_COMMA)||"null";return"await "+t+"("+r.join(", ")+");\n"},Blockly.JavaScript[Blockly.Gamepad.BLOCKS.START]=function(){return""},Blockly.JavaScript.addReservedWords("Blockly,CONTEXT,worker,code,reject,resolve,f"),Blockly.defineBlocksWithJsonArray([{type:Blockly.Gamepad.BLOCKS.START,message0:"Start",deletable_:!1,lastDummyAlign0:"CENTRE",nextStatement:null,style:"hat_blocks"}])},Blockly.Gamepad.init=function(e){if(!Blockly)throw new Error("Blockly library not included");if(!Blockly.hasOwnProperty("JavaScript"))throw new Error("JavaScript generator library not included");if(void 0===e)throw new Error("options must not be undefined");e.hasOwnProperty("inputs")&&(this.INPUTS=e.inputs),e.hasOwnProperty("toolbox")&&(this.TOOLBOX=Blockly.Gamepad.utils.xml2json(e.toolbox,"")),e.hasOwnProperty("context")&&(this.CONTEXT=e.context),e.hasOwnProperty("blocks")&&Blockly.Gamepad.utils.blocks(e.blocks,""),e.hasOwnProperty("wrap")&&Blockly.Gamepad.utils.wrap(e.wrap,"")},Blockly.Gamepad.BlocklyManager=class{constructor(e){e=e||{},this.isCoding=!1,this.start=!0===e.start,this.customHighlight=!0===e.customHighlight,this.workspace=e.workspace||Blockly.getMainWorkspace(),this.workspace.addChangeListener(e=>{e.type==Blockly.Events.BLOCK_MOVE&&(this.isCoding||this.removeHighlight(),this.isCoding=!0)}),this.reset()}code(e){this.isCoding=!1,this.start&&this.clear();let t=Blockly.JavaScript.workspaceToCode(this.workspace);return t=Blockly.Gamepad.utils.code(t,e)}clear(){let e=this.workspace.getTopBlocks();for(let t of e)t.type.includes("procedures_def")||this.start&&t.type==Blockly.Gamepad.BLOCKS.START||t.dispose(!1)}reset(){this.workspace.clear(),setTimeout(()=>{this.workspace.trashcan&&this.workspace.trashcan.clear()}),this.start&&(this.parentBlock=this.workspace.newBlock(Blockly.Gamepad.BLOCKS.START,Blockly.Gamepad.STATES.STARTED),this.parentBlock.setDeletable(!1),this.parentBlock.startHat_=!0,this.parentBlock.initSvg(),this.parentBlock.render(),this.parentBlock.setMovable(!1),this.parentBlock.moveBy(20,20)),this.workspace.scrollX=15,this.workspace.scrollY=15,this.workspace.undoStack_=[]}setToolbox(e){if(!e)return;let t=JSON.parse(Blockly.Gamepad.TOOLBOX);if("blocks"in e){if(!Array.isArray(e.blocks))throw new Error("options.blocks must be an array.");Blockly.Gamepad.utils.filter(t.XML,e),this.workspace.updateToolbox(Blockly.Gamepad.utils.json2xml(t))}else"all"in e&&this.workspace.updateToolbox(Blockly.Gamepad.utils.json2xml(t))}setHighlight(e){if(this.customHighlight){this.removeHighlight();try{document.querySelector("[data-id='"+e+"']").classList.add("blocklySelected")}catch(e){}}else this.workspace.highlightBlock(e)}removeHighlight(){if(this.customHighlight){let e=document.getElementsByClassName("blocklySelected");for(let t=e.length;t>0;t--)e[t-1].classList.remove("blocklySelected")}else this.workspace.highlightBlock()}getBlocksNumber(){let e=this.workspace.getAllBlocks(),t={total:0};for(let r of e)null==t[r.type]&&(t[r.type]=0),t[r.type]++,t.total++;return t}save(e){if("undefined"!=typeof Storage){let t=Blockly.Xml.workspaceToDom(this.workspace);localStorage.setItem(e,Blockly.Xml.domToText(t))}}restore(e){if("undefined"!=typeof Storage){if(null!=localStorage.getItem(e)){this.workspace.clear();try{let t=Blockly.Xml.textToDom(localStorage.getItem(e));Blockly.Xml.domToWorkspace(t,this.workspace)}catch(e){this.reset()}}if(this.workspace.trashcan&&this.workspace.trashcan.clear(),this.start){let e=this.workspace.getTopBlocks();for(let t of e)if(t.type==Blockly.Gamepad.BLOCKS.START)return;this.reset()}}}resize(){Blockly.svgResize(this.workspace)}},Blockly.Gamepad.History=class{constructor(){this.reset()}get length(){return this.history.length}add(e,t){this.history.splice(this.index+1),this.history.push(e),t&&(this.index=this.length-1)}get next(){if(this.index<this.length-1)return this.history[++this.index]}get prior(){if(this.index>-1)return this.history[--this.index]}get current(){if(this.index>-1)return this.history[this.index]}reset(){this.index=-1,this.history=[]}},Blockly.Gamepad.Queue=class{constructor(){this.requests=[],this.closed=!1,this.setListener()}setListener(){this.listener=new Promise((e,t)=>{this.setted=(r=>r?r.close?e(!0):r.reset?t(Blockly.Gamepad.ERRORS.CLOSED):void e():e())}),this.listener.then(()=>{},()=>{})}reset(){this.requests=[],this.closed=!1,this.setted({reset:!0}),this.setListener()}close(){this.closed=!0,this.setted({close:!0})}open(){this.closed=!1}get(){return this.closed?Promise.resolve():this.listener.then(e=>{if(e)return void this.setListener();let t=this.requests.shift();return this.setListener(),0!=this.requests.length&&this.setted(),t})}set(e){this.requests.push(e),this.setted()}},Blockly.Gamepad.Asynchronizer=class{constructor(e,t,r){this.sync=e||{},this.async={},this.onRun=t||function(){},this.onReset=r||function(){},this.state=Blockly.Gamepad.utils.promiseWrapper(),this.state.resolve(),this.handler={get:function(e,t){if(Object.getOwnPropertySymbols(e).includes(Blockly.Gamepad.SYMBOL))throw Blockly.Gamepad.ERRORS.CLOSED;return e[t]}}}reset(){if(!this.state.isPending())return this.state=Blockly.Gamepad.utils.promiseWrapper(),this.async[Blockly.Gamepad.SYMBOL]=!0,this.onReset.apply(this.sync,[...arguments])}run(){if(this.state.isFulfilled())return;this.async=new Proxy(this.sync&&this.sync.prototype?new this.sync:Object.defineProperties(Object.assign({},this.sync),Object.getOwnPropertyDescriptors(this.sync)),this.handler);let e=this.onRun.apply(this.async,[...arguments]);return e instanceof Promise?e.then(e=>(this.state.resolve(),e)):(this.state.resolve(),e)}},Blockly.Gamepad.Worker=function(){const e=new Blockly.Gamepad.Asynchronizer({history:new Blockly.Gamepad.History,queue:new Blockly.Gamepad.Queue,requests:new Blockly.Gamepad.Queue,debugger:{id:null,promise:Blockly.Gamepad.utils.promiseWrapper()},isRunning:!1,back:!1,go:function(e){return new Promise(t=>{this.queue.set({back:!0===e,resolve:t})})},freeQueue:function(){this.queue.close();const e=this.queue.requests;this.queue.reset(),e.forEach(e=>e&&e.resolve&&e.resolve(!1))},start:function(e){this.back=!0===e,this.isRunning||(this.isRunning=!0,this.queue.close(),this.queue.open())},stop:function(){this.isRunning=!1,this.removeBreakpoint()},setRequest:function(e){return new Promise((t,r)=>{this.requests.set({request:e,resolve:t,reject:r})})},close:function(){this.requests.close()},open:function(){this.requests.open()},setBreakpoint:function(e){if(void 0!==e&&(null!==e||null!==this.debugger.id))return this.debugger.promise.isPending()&&this.debugger.promise.resolve(!1),this.debugger.id=e,this.debugger.promise=Blockly.Gamepad.utils.promiseWrapper(),this.debugger.promise.then(e=>e)},removeBreakpoint:function(){this.setBreakpoint(null)}},function(){const e=async()=>{let e=this.history.current;this.history.prior,void 0!==e?(await this.manage(e,!0,!0),r(e.id)):this.stop()},t=async()=>{let e,t;if(void 0!==(e=this.history.next))return await this.manage(e,!1,!0),void r(e.id);if(void 0!==(e=await this.requests.get())){if(this.history.current){if(this.history.current.method==Blockly.Gamepad.STATES.FINISHED&&e.request.method!=Blockly.Gamepad.STATES.STARTED&&e.request.method!=Blockly.Gamepad.STATES.COMPLETED)return void e.reject(Blockly.Gamepad.ERRORS.FINISHED);if(this.history.current.method==Blockly.Gamepad.STATES.COMPLETED)return e.reject(Blockly.Gamepad.ERRORS.COMPLETED),void this.stop()}void 0===(t=await this.manage(e.request,!1,!1))&&(t={}),this.history.add(e.request,!0),r(e.request.id),t.finished?(this.history.add(Blockly.Gamepad.utils.build(Blockly.Gamepad.STATES.FINISHED,[],Blockly.Gamepad.STATES.FINISHED,{generated:!0}),!0),this.history.next,r(Blockly.Gamepad.STATES.FINISHED),e.reject(Blockly.Gamepad.ERRORS.FINISHED)):t.completed?(this.history.add(Blockly.Gamepad.utils.build(Blockly.Gamepad.STATES.COMPLETED,[],Blockly.Gamepad.STATES.COMPLETED,{generated:!0}),!0),this.history.next,r(Blockly.Gamepad.STATES.COMPLETED),e.reject(Blockly.Gamepad.ERRORS.COMPLETED),this.close()):e.resolve(t.return)}else this.stop()},r=e=>{null!==this.debugger.id&&this.debugger.id==e&&(this.debugger.promise.resolve(!0),this.freeQueue(),this.stop())};(async()=>{try{for(;;){let r=this.isRunning?{back:this.back}:await this.queue.get()||{p:"p",back:this.back};r.back?await e():await t(),r.resolve&&r.resolve(!0)}}catch(e){Blockly.Gamepad.utils.errorHandler(e)}})()},function(){this.freeQueue(),this.queue.reset(),this.requests.reset(),this.history.reset(),this.removeBreakpoint()});Object.assign(this,{reset:function(){e.reset(),e.run()},onRequest:function(t,r){e.sync.manage=function(e,o,s){return r.apply(t,[e,o,s])}},getInstance:function(){return e.async}});for(const t of["go","setRequest","start","stop","close","freeQueue","setBreakpoint","removeBreakpoint"])this[t]=function(){let r=e.async;try{return r[t].apply(r,[...arguments])}catch(e){Blockly.Gamepad.utils.errorHandler(e)}};for(const t of["isRunning","back"])Object.defineProperty(this,t,{get:function(){try{return e.async[t]}catch(e){}}});this.reset()},Blockly.Gamepad.evalContext=function(code,worker){try{let CONTEXT=Blockly.Gamepad.CONTEXT;eval(code)}catch(e){console.error("There's an error in the code: \n",code),console.error(e)}},Blockly.Gamepad.observer={INSERT:"insert",UPDATE:"update",DELETE:"delete",POP:"pop",PUSH:"push",SHIFT:"shift",UNSHIFT:"unshift",REVERSE:"reverse",nonObservables:{Date:!0,Blob:!0,Number:!0,String:!0,Boolean:!0,Error:!0,SyntaxError:!0,TypeError:!0,URIError:!0,Function:!0,Promise:!0,RegExp:!0},observableDefinition:{revoke:{value:function(){this[Blockly.Gamepad.SYMBOL].revoke()}},observe:{value:function(e,t){let r=this[Blockly.Gamepad.SYMBOL].observers;if("function"!=typeof e)throw new Error("observer parameter MUST be a function");r.has(e)||r.set(e,Object.assign({},t))}},unobserve:{value:function(){let e,t=this[Blockly.Gamepad.SYMBOL].observers;if(t.size)if(e=arguments.length)for(;e--;)t.delete(arguments[e]);else t.clear()}}},prepareArray:function(e,t){let r,o=e.length,s=new Array(e.length);for(s[Blockly.Gamepad.SYMBOL]=t;o--;)(r=e[o])&&"object"==typeof r&&!Blockly.Gamepad.observer.nonObservables.hasOwnProperty(r.constructor.name)?s[o]=Array.isArray(r)?new Blockly.Gamepad.ArrayObserver({target:r,ownKey:o,parent:t}).proxy:new Blockly.Gamepad.ObjectObserver({target:r,ownKey:o,parent:t}).proxy:s[o]=r;return s},prepareObject:function(e,t){let r,o,s=Object.keys(e),a=s.length,l={[Blockly.Gamepad.SYMBOL]:t};for(;a--;)(o=e[r=s[a]])&&"object"==typeof o&&!Blockly.Gamepad.observer.nonObservables.hasOwnProperty(o.constructor.name)?l[r]=Array.isArray(o)?new Blockly.Gamepad.ArrayObserver({target:o,ownKey:r,parent:t}).proxy:new Blockly.Gamepad.ObjectObserver({target:o,ownKey:r,parent:t}).proxy:l[r]=o;return l},callObservers:function(e,t){for(let r of e.keys())try{r(t)}catch(e){console.error("failed to deliver changes to listener "+r,e)}},getAncestorInfo:function(e){let t,r=[],o=0,s=0;if(!e.isRevoked){for(;e.parent;)if(r[o++]=e.ownKey,(e=e.parent).isRevoked)return;for(t=new Array(o);o--;)t[s++]=r[o];return{observers:e.observers,path:t}}},getLastProp:function(e,t){for(let r=0;r<t.length-1;r++)e=e[t[r]];return{key:t[t.length-1],target:e}},loadChange:function(e,t){let{target:r,key:o}=Blockly.Gamepad.observer.getLastProp(e,t.path);Array.isArray(r)?(t.type==Blockly.Gamepad.observer.INSERT&&(r.length>o?r.splice(o,0,t.value):r[o]=t.value),t.type==Blockly.Gamepad.observer.DELETE&&r.splice(o,1)):(t.type==Blockly.Gamepad.observer.INSERT&&(r[o]=t.value),t.type==Blockly.Gamepad.observer.DELETE&&delete r[o]),t.type==Blockly.Gamepad.observer.PUSH&&r[o].push.apply(r,t.value),t.type==Blockly.Gamepad.observer.POP&&r[o].pop(),t.type==Blockly.Gamepad.observer.UNSHIFT&&r[o].unshift.apply(r,t.value),t.type==Blockly.Gamepad.observer.SHIFT&&r[o].shift(),t.type==Blockly.Gamepad.observer.REVERSE&&r[o].reverse(),t.type==Blockly.Gamepad.observer.UPDATE&&(r[o]=t.value)},unloadChange:function(e,t){let{target:r,key:o}=Blockly.Gamepad.observer.getLastProp(e,t.path);if(Array.isArray(r)?(t.type==Blockly.Gamepad.observer.INSERT&&(r.length>o?r.splice(o,1):delete r[o]),t.type==Blockly.Gamepad.observer.DELETE&&r.splice(o,0,t.oldValue)):(t.type==Blockly.Gamepad.observer.INSERT&&delete r[o],t.type==Blockly.Gamepad.observer.DELETE&&(r[o]=t.oldValue)),t.type==Blockly.Gamepad.observer.PUSH)for(let e=0;e<t.value.length;e++)r[o].pop();if(t.type==Blockly.Gamepad.observer.POP&&r[o].push(t.oldValue),t.type==Blockly.Gamepad.observer.UNSHIFT)for(let e=0;e<t.value.length;e++)r[o].shift();t.type==Blockly.Gamepad.observer.SHIFT&&r[o].unshift(t.oldValue),t.type==Blockly.Gamepad.observer.REVERSE&&r[o].reverse(),t.type==Blockly.Gamepad.observer.UPDATE&&(r[o]=t.oldValue)},observeJson:function(e){if(!(!e||"object"!=typeof e||Blockly.Gamepad.observer.nonObservables.hasOwnProperty(e.constructor.name)||"observe"in e||"unobserve"in e||"revoke"in e)){return(Array.isArray(e)?new Blockly.Gamepad.ArrayObserver({target:e,ownKey:null,parent:null}):new Blockly.Gamepad.ObjectObserver({target:e,ownKey:null,parent:null})).proxy}if(!e||"object"!=typeof e)throw new Error("observable MAY ONLY be created from non-null object only");if("observe"in e||"unobserve"in e||"revoke"in e)throw new Error('target object MUST NOT have nor own neither inherited properties from the following list: "observe", "unobserve", "revoke"');if(Blockly.Gamepad.observer.nonObservables.hasOwnProperty(e.constructor.name))throw new Error(e+" found to be one of non-observable object types: "+Blockly.Gamepad.observer.nonObservables)}},Blockly.Gamepad.Observer=class{constructor(e,t){let r=t(e.target,this);null===e.parent?(this.isRevoked=!1,Object.defineProperty(this,"observers",{value:new Map}),Object.defineProperties(r,Blockly.Gamepad.observer.observableDefinition)):(this.parent=e.parent,this.ownKey=e.ownKey),this.revokable=Proxy.revocable(r,this),this.proxy=this.revokable.proxy,this.target=r}set(e,t,r){if(this.isRevoked)return e[t]=r,!0;let o,s,a,l=e[t];if(o=r&&"object"==typeof r&&!Blockly.Gamepad.observer.nonObservables.hasOwnProperty(r.constructor.name)?Array.isArray(r)?new Blockly.Gamepad.ArrayObserver({target:r,ownKey:t,parent:this}).proxy:new Blockly.Gamepad.ObjectObserver({target:r,ownKey:t,parent:this}).proxy:r,e[t]=o,l&&"object"==typeof l){let e=l[Blockly.Gamepad.SYMBOL];e&&(l=e.revoke())}return(s=Blockly.Gamepad.observer.getAncestorInfo(this))?(s.observers.size&&(s.path.push(t),a=void 0===l?[{type:Blockly.Gamepad.observer.INSERT,path:s.path,value:o,object:this.proxy}]:[{type:Blockly.Gamepad.observer.UPDATE,path:s.path,value:o,oldValue:l,object:this.proxy}],Blockly.Gamepad.observer.callObservers(s.observers,a)),!0):void 0}deleteProperty(e,t){let r,o,s=e[t];if(delete e[t]){if(s&&"object"==typeof s){let e=s[Blockly.Gamepad.SYMBOL];e&&(s=e.revoke())}if(!(r=Blockly.Gamepad.observer.getAncestorInfo(this)))return;return r.observers.size&&(r.path.push(t),o=[{type:Blockly.Gamepad.observer.DELETE,path:r.path,oldValue:s,object:this.proxy}],Blockly.Gamepad.observer.callObservers(r.observers,o)),!0}return!1}},Blockly.Gamepad.ArrayObserver=class extends Blockly.Gamepad.Observer{constructor(e){super(e,Blockly.Gamepad.observer.prepareArray)}revoke(){this.isRevoked=!0;let e,t=this.target,r=t.length;for(;r--;)if((e=t[r])&&"object"==typeof e){let o=e[Blockly.Gamepad.SYMBOL];o&&(t[r]=o.revoke())}return t}get(e,t){const r={pop:function(e,t){if(0==e.length)return;let r;if((r=e.pop())&&"object"==typeof r){let e=r[Blockly.Gamepad.SYMBOL];e&&(r=e.revoke())}let o=Blockly.Gamepad.observer.getAncestorInfo(t);return o?(o.observers.size&&Blockly.Gamepad.observer.callObservers(o.observers,[{type:Blockly.Gamepad.observer.POP,path:o.path,oldValue:r,object:t.proxy}]),r):void 0},push:function(e,t){let r,o,s,a,l,i=arguments.length-2,n=new Array(i),c=Blockly.Gamepad.observer.getAncestorInfo(t);for(l=e.length,r=0;r<i;r++)(o=arguments[r+2])&&"object"==typeof o&&!Blockly.Gamepad.observer.nonObservables.hasOwnProperty(o.constructor.name)&&(o=Array.isArray(o)?new Blockly.Gamepad.ArrayObserver({target:o,ownKey:l+r,parent:t}).proxy:new Blockly.Gamepad.ObjectObserver({target:o,ownKey:l+r,parent:t}).proxy),n[r]=o;if(s=Reflect.apply(e.push,e,n),c)return c.observers.size&&(a=[{type:Blockly.Gamepad.observer.PUSH,path:c.path,value:n,object:t.proxy}],Blockly.Gamepad.observer.callObservers(c.observers,a)),s},shift:function(e,t){if(0==e.length)return;let r,o,s,a,l,i;if((r=e.shift())&&"object"==typeof r){let e=r[Blockly.Gamepad.SYMBOL];e&&(r=e.revoke())}for(o=0,s=e.length;o<s;o++)if((a=e[o])&&"object"==typeof a){let e=a[Blockly.Gamepad.SYMBOL];e&&(e.ownKey=o)}return(l=Blockly.Gamepad.observer.getAncestorInfo(t))?(l.observers.size&&(i=[{type:Blockly.Gamepad.observer.SHIFT,path:l.path,oldValue:r,object:t.proxy}],Blockly.Gamepad.observer.callObservers(l.observers,i)),r):void 0},unshift:function(e,t){let r,o,s,a;(r=Array.from(arguments)).splice(0,2),r.forEach((e,o)=>{e&&"object"==typeof e&&!Blockly.Gamepad.observer.nonObservables.hasOwnProperty(e.constructor.name)&&(r[o]=Array.isArray(e)?new Blockly.Gamepad.ArrayObserver({target:e,ownKey:o,parent:t}).proxy:new Blockly.Gamepad.ObjectObserver({target:e,ownKey:o,parent:t}).proxy)}),o=Reflect.apply(e.unshift,e,r);for(let t,r=0,o=e.length;r<o;r++)if((t=e[r])&&"object"==typeof t){let e=t[Blockly.Gamepad.SYMBOL];e&&(e.ownKey=r)}if(s=Blockly.Gamepad.observer.getAncestorInfo(t))return s.observers.size&&(a=[{type:Blockly.Gamepad.observer.UNSHIFT,path:s.path,value:r,object:t.proxy}],Blockly.Gamepad.observer.callObservers(s.observers,a)),o},reverse:function(e,t){let r,o,s,a,l;for(e.reverse(),r=0,o=e.length;r<o;r++)if((s=e[r])&&"object"==typeof s){let e=s[Blockly.Gamepad.SYMBOL];e&&(e.ownKey=r)}if(a=Blockly.Gamepad.observer.getAncestorInfo(t))return a.observers.size&&(l=[{type:Blockly.Gamepad.observer.REVERSE,path:a.path,object:t.proxy}],Blockly.Gamepad.observer.callObservers(a.observers,l)),t.proxy},sort:function(e,t,r){let o,s,a,l,i,n=e.slice(0);for(e.sort(r),o=0,s=e.length;o<s;o++)if((a=e[o])&&"object"==typeof a){let e=a[Blockly.Gamepad.SYMBOL];e&&(e.ownKey=o)}if(l=Blockly.Gamepad.observer.getAncestorInfo(t))return l.observers.size&&(i=[{type:Blockly.Gamepad.observer.UPDATE,value:e,oldValue:n,path:l.path,object:t.proxy}],Blockly.Gamepad.observer.callObservers(l.observers,i)),t.proxy},fill:function(e,t){let r,o,s,a,l,i,n=Blockly.Gamepad.observer.getAncestorInfo(t),c=[],p=e.length;(r=Array.from(arguments)).splice(0,2),s=(o=r.length)<2?0:r[1]<0?p+r[1]:r[1],a=o<3?p:r[2]<0?p+r[2]:r[2],l=e.slice(0),Reflect.apply(e.fill,e,r);for(let r,o,p=s;p<a;p++)if((r=e[p])&&"object"==typeof r&&!Blockly.Gamepad.observer.nonObservables.hasOwnProperty(r.constructor.name)&&(e[p]=Array.isArray(r)?new Blockly.Gamepad.ArrayObserver({target:r,ownKey:p,parent:t}).proxy:new Blockly.Gamepad.ObjectObserver({target:r,ownKey:p,parent:t}).proxy),l.hasOwnProperty(p)){if((o=l[p])&&"object"==typeof o){let e=o[Blockly.Gamepad.SYMBOL];e&&(o=e.revoke())}(i=n.path.slice(0)).push(p),c.push({type:Blockly.Gamepad.observer.UPDATE,path:i,value:e[p],oldValue:o,object:t.proxy})}else(i=n.path.slice(0)).push(p),c.push({type:Blockly.Gamepad.observer.INSERT,path:i,value:e[p],object:t.proxy});if(n)return n.observers.size&&Blockly.Gamepad.observer.callObservers(n.observers,c),t.proxy},splice:function(e,t){let r,o,s,a,l,i,n,c,p,h,y=Blockly.Gamepad.observer.getAncestorInfo(t),d=[],u=e.length;(r=Array.from(arguments)).splice(0,2),n=r.length;for(let e,o=2;o<n;o++)(e=r[o])&&"object"==typeof e&&!Blockly.Gamepad.observer.nonObservables.hasOwnProperty(e.constructor.name)&&(r[o]=Array.isArray(e)?new Blockly.Gamepad.ArrayObserver({target:e,ownKey:o,parent:t}).proxy:new Blockly.Gamepad.ObjectObserver({target:e,ownKey:o,parent:t}).proxy);a=0===n?0:r[0]<0?u+r[0]:r[0],l=n<2?u-a:r[1],i=Math.max(n-2,0),o=Reflect.apply(e.splice,e,r),u=e.length;for(let t,r=0;r<u;r++)(t=e[r])&&"object"==typeof t&&(s=t[Blockly.Gamepad.SYMBOL])&&(s.ownKey=r);for(c=0,p=o.length;c<p;c++)(h=o[c])&&"object"==typeof h&&(s=h[Blockly.Gamepad.SYMBOL])&&(o[c]=s.revoke());if(y){if(y.observers.size){let r,s;for(r=0;r<l;r++)(s=y.path.slice(0)).push(a+r),r<i?d.push({type:Blockly.Gamepad.observer.UPDATE,path:s,value:e[a+r],oldValue:o[r],object:t.proxy}):d.push({type:Blockly.Gamepad.observer.DELETE,path:s,oldValue:o[r],object:t.proxy});for(;r<i;r++)(s=y.path.slice(0)).push(a+r),d.push({type:Blockly.Gamepad.observer.INSERT,path:s,value:e[a+r],object:t.proxy});Blockly.Gamepad.observer.callObservers(y.observers,d)}return o}}};return r.hasOwnProperty(t)?r[t].bind(void 0,e,this):e[t]}},Blockly.Gamepad.ObjectObserver=class extends Blockly.Gamepad.Observer{constructor(e){super(e,Blockly.Gamepad.observer.prepareObject)}revoke(){this.isRevoked=!0;let e,t,r=this.target,o=Object.keys(r),s=o.length;for(;s--;)if((t=r[e=o[s]])&&"object"==typeof t){let o=t[Blockly.Gamepad.SYMBOL];o&&(r[e]=o.revoke())}return r}},Blockly.Gamepad.Store=class{constructor(e){this.observer=Blockly.Gamepad.observer.observeJson(e),this.history=[],this.index=-1,this.changes=[],this.observer.observe(e=>{e.forEach(e=>{"value"in e&&null!=e.value&&(e.value=JSON.parse(JSON.stringify(e.value))),"oldValue"in e&&null!=e.oldValue&&(e.oldValue=JSON.parse(JSON.stringify(e.oldValue))),this.changes.push(e)})})}commit(){this.history.splice(this.index+1),this.history.push(this.changes),this.index=this.history.length-1,this.changes=[]}restore(){let e=this.changes.slice(0);for(;e.length>0;)Blockly.Gamepad.observer.unloadChange(this.observer,e.pop());this.changes=[]}loadChanges(){if(this.restore(),this.index<this.history.length-1){this.index++;let e=this.history[this.index],t=-1;for(;++t<e.length;)Blockly.Gamepad.observer.loadChange(this.observer,e[t]);this.changes=[]}}unloadChanges(){if(this.restore(),this.index>-1){let e=this.history[this.index],t=e.length;for(;--t>=0;)Blockly.Gamepad.observer.unloadChange(this.observer,e[t]);this.index--,this.changes=[]}}},Blockly.Gamepad.JsonManager=class{constructor(e){this.init(e||{})}reset(){this.init()}init(e){if(void 0!==e&&(this.json=e),this.stores=[],this.index=0,Array.isArray(this.json))for(let e of this.json)this.stores.push(new Blockly.Gamepad.Store(e));else this.stores.push(new Blockly.Gamepad.Store(this.json));Object.freeze(this.stores)}get store(){return this.stores[this.index]}get observer(){return this.store.observer}get observers(){return this.stores.map(e=>e.observer)}get history(){return this.store.history}get changes(){return this.store.changes}set changes(e){this.store.changes=e}commit(){this.store.commit()}loadChanges(){this.store.loadChanges()}unloadChanges(){this.store.unloadChanges()}loadNext(){this.index<this.stores.length-1&&this.index++}loadPrior(){this.index>0&&this.index--}},Blockly.Gamepad.setting();